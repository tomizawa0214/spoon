{% extends "app/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block title %}
<title>お持ち帰り予約 - 商品注文 | spoon</title>
{% endblock %}

{% block order %}
<div class="order__header align-items-center d-sm-none">
    <div class="order__header--menu size-jump d-flex flex-column justify-content-center text-center p-2">
        <img class="order__header--menu--icon" src="{% static 'img/step1.svg' %}" alt="サイズを選ぶ">
        <span class="order__header--menu--text">サイズを選ぶ</span>
    </div>
    <div class="order__header--menu flavor-jump d-flex flex-column justify-content-center text-center p-2">
        <img class="order__header--menu--icon" src="{% static 'img/step2.svg' %}" alt="フレーバーを選ぶ">
        <span class="order__header--menu--text">フレーバーを選ぶ</span>
    </div>
    <div class="order__header--menu option-jump d-flex flex-column justify-content-center text-center p-2">
        <img class="order__header--menu--icon" src="{% static 'img/step3.svg' %}" alt="オプションを選ぶ">
        <span class="order__header--menu--text">オプションを選ぶ</span>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="mx-auto">
    <div class="row">
        <div class="col-sm-6 col-lg-8">
            <h1 class="title">
                <span>お持ち帰り予約</span>
            </h1>
            <p class="order__step order__size mb-3 py-1 px-3 px-md-2 rounded-sm-pill">STEP1. ジェラートのサイズをお選びください。<br>
                <span class="order__step--help d-inline-block mt-1">※写真はイメージです。お持ち帰り用は別カップになります。</span>
            </p>
            <div class="mx-auto text-center">
                <p id="size_error" class="d-none"></p>
            </div>
            <ul class="row justify-content-center list-unstyled mb-5">
                {% for size in size_item %}
                    <li class="order__select col-lg-3 mb-3 mb-lg-0 text-center">
                        <input id="size_{{ size.id }}" type="checkbox" name="size" value="{{ size.title }} {{ size.price }}" onclick="sizeChk(this);">
                        <label for="size_{{ size.id }}">
                            <div class="d-flex d-lg-block">
                                <img class="order__select--img" src="{{ size.image.url }}">
                                <div class="d-flex flex-column justify-content-end d-lg-inline-block text-left text-lg-center mt-lg-2">
                                    <p class="order__select--item mb-1 ml-2 ml-lg-0 mt-1 mt-lg-0 text-left">{{ size.title }}</p>
                                    <p class="order__select--item order__select--price ml-2 ml-lg-0 mb-lg-0 text-left">&yen;{{ size.price }}</p>
                                </div>
                            </div>
                        </label>
                    </li>
                {% endfor %}
            </ul>
            <p class="order__step order__flavor mb-3 py-1 px-3 px-md-2 rounded-sm-pill">STEP2. ジェラートのフレーバーをお選びください。<br>
                <span class="order__step--help d-inline-block mt-1">※写真はイメージです。お持ち帰り用は別カップになります。</span>
            </p>
            <div class="class mx-auto text-center">
                <p id="flavor_error" class="d-none"></p>
            </div>
            <ul class="row mb-5 list-unstyled">
                {% for flavor in flavor_item %}
                    <li class="order__select col-lg-3 text-center">
                        <input id="flavor_{{ flavor.id }}" type="checkbox" name="flavor" value="{{ flavor.title }} {{ flavor.price }}" onclick="flavorChk(this);">
                        <label for="flavor_{{ flavor.id }}">
                            <div class="d-flex d-lg-block">
                                <img class="order__select--img" src="{{ flavor.image.url }}">
                                <div class="d-flex flex-column justify-content-end text-left">
                                    <p class="order__select--item mb-1 ml-2">{{ flavor.title }}</p>
                                    <p class="order__select--item order__select--item--flavor order__select--price ml-2">&yen;{{ flavor.price }}</p>
                                </div>
                            </div>
                        </label>
                    </li>
                {% endfor %}
                </ul>
            <p class="order__step order__option mb-3 py-1 px-3 px-md-2 rounded-sm-pill">STEP3. オプションをお選びください。<br>
                <span class="order__step--help d-inline-block mt-1">
                    ※コーンはお持ち帰り用に単品でのお渡しとなります。
                    お持ち帰りに30分以上かかる場合はドライアイスをおすすめします。
                    レジ袋はエコバッグをご持参いただければ不要です。
                    写真はイメージです。
                </span>
            </p>
            <ul class="row list-unstyled">
                {% for option in option_item %}
                    <li class="order__select col-lg-3 text-center">
                        <input id="option_{{ option.id }}" type="checkbox" name="option" value="{{ option.title }} {{ option.price }}" onclick="to_check()">
                        <label for="option_{{ option.id }}">
                            <div class="d-flex d-lg-block">
                                <img class="order__select--img" src="{{ option.image.url }}">
                                <div class="d-flex flex-column justify-content-end text-left">
                                    <p class="order__select--item mb-1 ml-2 mt-1 mt-lg-0">{{ option.title }}</p>
                                    <p class="order__select--item order__select--price ml-2">&yen;{{ option.price }}</p>
                                </div>
                            </div>
                        </label>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <!-- カート -->
        <div class="col-sm-6 col-lg-4 px-3">
            <div class="order__cart card sticky-top mx-auto mt-5 mt-sm-2 ml-md-4">
                <p class="order__cart--content text-center p-1 mb-3">ご注文内容</p>
                <!-- データベース用 -->
                <div id="posts">
                    {% for cart in cart_data %}
                        <div id="order{{ cart.id }}" class="mb-3">
                            <div class="d-flex justify-content-between mx-2">
                                <strong class="order__cart--content--size">{{ cart.size_title }}</strong>
                                <div>
                                    <strong class="order__select--cart--price m-0">&yen;{{ cart.size_price }}</strong>
                                    <span id="{{ cart.id }}" onclick="delOrder(this);">
                                        <i class="order__select--cart--delete fas fa-times-circle fa-fw" aria-hidden="true"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="order__select--cart d-flex justify-content-between mx-2">
                                <span>{{ cart.flavor_title }}</span>
                                <span class="order__select--cart--price order__cart--content--flavor">&yen;{{ cart.flavor_price }}</span>
                            </div>
                            <div class="order__select--cart d-flex justify-content-between mx-2">
                                <span>{{ cart.flavor2_title }}</span>
                                {% if cart.flavor2_title != "" %}
                                    <span class="order__select--cart--price">&yen;{{ cart.flavor2_price }}</span>
                                {% endif %}
                            </div>
                            <div class="order__select--cart d-flex justify-content-between mx-2">
                                <span>{{ cart.option_title }}</span>
                                {% if cart.option_title != "" %}
                                    <span class="order__select--cart--price">&yen;{{ cart.option_price }}</span>
                                {% endif %}
                            </div>
                            <div class="order__select--cart d-flex justify-content-between mx-2">
                                <span>{{ cart.option2_title }}</span>
                                {% if cart.option2_title != "" %}
                                    <span class="order__select--cart--price">&yen;{{ cart.option2_price }}</span>
                                {% endif %}
                            </div>
                            <div class="order__select--cart d-flex justify-content-between mx-2">
                                <span>{{ cart.option3_title }}</span>
                                {% if cart.option3_title != "" %}
                                    <span class="order__select--cart--price">&yen;{{ cart.option3_price }}</span>
                                {% endif %}
                            </div>
                            <div class="order__select--cart d-flex justify-content-between mx-2">
                                <span>{{ cart.option4_title }}</span>
                                {% if cart.option4_title != "" %}
                                    <span class="order__select--cart--price">&yen;{{ cart.option4_price }}</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <!-- リアルタイム更新用 -->
                <div class="d-flex justify-content-between mx-2">
                    <strong id="size_title"></strong>
                    <strong id="size_price" class="order__select--cart--price"></strong>
                </div>
                <div class="order__select--cart d-flex justify-content-between mx-2">
                    <span id="flavor_title"></span>
                    <span id="flavor_price" class="order__select--cart--price"></span>
                </div>
                <div class="order__select--cart d-flex justify-content-between mx-2">
                    <span id="flavor2_title"></span>
                    <span id="flavor2_price" class="order__select--cart--price"></span>
                </div>
                <div class="order__select--cart d-flex justify-content-between mx-2">
                    <span id="option_title"></span>
                    <span id="option_price" class="order__select--cart--price"></span>
                </div>
                <div class="order__select--cart d-flex justify-content-between mx-2">
                    <span id="option2_title"></span>
                    <span id="option2_price" class="order__select--cart--price"></span>
                </div>
                <div class="order__select--cart d-flex justify-content-between mx-2">
                    <span id="option3_title"></span>
                    <span id="option3_price" class="order__select--cart--price"></span>
                </div>
                <div class="order__select--cart d-flex justify-content-between mx-2">
                    <span id="option4_title"></span>
                    <span id="option4_price" class="order__select--cart--price"></span>
                </div>
                <hr class="order__cart--border mx-2">
                <div class="order__cart--total d-flex justify-content-between mx-2 mb-4">
                    <strong>合計</strong>
                    <span id="total" class="d-none">0</span>
                    <span id="total_price" class="order__select--price">&yen;{{ get_total_price|intcomma }}</span>
                </div>
                <div class="order__btn">
                    <!-- 注文ボタン -->
                    <div class="mx-auto text-center">
                        <a id="order_plus" class="order__btn--add d-inline-block btn rounded-pill mt-0" ontouchstart="">追加注文</a><br>
                        <a id="order_next" class="order__btn--next d-inline-block btn rounded-pill my-4" href="{% url 'order_user' %}" ontouchstart="">ご注文手続きへ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extrajs %}
<script>
    'use strict'

    animation('.order__select');
    // スクロールで発動
    window.addEventListener('scroll', () => {
        animation('.order__select');
    });

    // ウインドウ幅に応じてbody要素を変更
    if ( window.innerWidth < 576 ) {
        document.body.style.paddingTop = '124px';
    } else if ( window.innerWidth < 768 ) {
        document.body.style.paddingTop = '60px';
    }

    window.addEventListener('resize', event => {
        if ( window.innerWidth < 576 ) {
            document.body.style.paddingTop = '124px';
        } else if ( window.innerWidth < 768 ) {
            document.body.style.paddingTop = '60px';
        } else {
            document.body.style.paddingTop = 0;
        }
    });

    // サイズ・フレーバー・オプションを取得
    let size = document.getElementsByName('size')
    let flavor = document.getElementsByName('flavor')
    let option = document.getElementsByName('option')
    // フレーバのプライスエリアを取得
    const flavorPriceArea = document.querySelectorAll('.order__select--item--flavor');
    // カート内のフィールドを取得
    const size_title = document.getElementById('size_title');
    const size_price = document.getElementById('size_price');
    const flavor_title = document.getElementById('flavor_title');
    const flavor_price = document.getElementById('flavor_price');
    const flavor2_title = document.getElementById('flavor2_title');
    const flavor2_price = document.getElementById('flavor2_price');
    const option_title = document.getElementById('option_title');
    const option_price = document.getElementById('option_price');
    const option2_title = document.getElementById('option2_title');
    const option2_price = document.getElementById('option2_price');
    const option3_title = document.getElementById('option3_title');
    const option3_price = document.getElementById('option3_price');
    const option4_title = document.getElementById('option4_title');
    const option4_price = document.getElementById('option4_price');
    const total = document.getElementById('total');
    const total_price = document.getElementById('total_price');
    // エラーフィールドを取得
    const size_error = document.getElementById('size_error');
    const flavor_error = document.getElementById('flavor_error');
    // 登録フィールドを取得
    const postArea = document.getElementById('posts')

    // 空の表示
    const order_total = document.querySelector('.order__cart--total');
    if ( total_price.textContent == '\xA50' && flavor_title.textContent == '' ) {
        order_total.className = 'order__cart--total d-none';
        document.querySelector('.order__cart--border').className = 'order__cart--border d-none';
        document.querySelector('.order__btn').className = 'order__btn d-none';
        order_total.insertAdjacentHTML(
            'beforebegin',
            '<p class="order__none mb-4">カートは空です。<br>ぜひお買い物をお楽しみください。</p>'
        );
    }

    // 選択解除
    const invalid = (type) => {
        for ( let i = 0; i < type.length; i++ ) {
            type[i].checked = false;
        }
    }

    // サイズをクリックで発動
    const sizeChk = (ele) => {
        // 選択されたサイズのidを取得
        var size_chk = document.getElementById(ele.id);
        // サイズが選択されていると発動
        if ( size_chk.checked ) {
            // すべてのチェックを一旦外す
            invalid(size);
            invalid(flavor);
            invalid(option);
            // 該当だけチェックを付け直す
            size_chk.checked = true;
        }
        to_check()
    }

    // フレーバーをクリックで発動
    const flavorChk = (ele) => {
        // 選択されたフレーバーのidを取得
        let flavor_chk = document.getElementById(ele.id);
        // ダブルサイズが選択されている場合の処理
        if ( size[2].checked ) {
            // 2個までは選択可
            let count = 0;
            for ( let i = 0; i < flavor.length; i++ ) {
                if ( flavor[i].checked ) {
                    count++;
                }
            }
            // 既に2個選択されている場合
            if ( count == 3 ) {
                // すべてのチェックを一旦外す
                invalid(flavor);
                // 該当だけチェックを付け直す
                flavor_chk.checked = true;
            }
        } else {
            // フレーバーが選択されていると発動
            if ( flavor_chk.checked ) {
                // すべてのチェックを一旦外す
                invalid(flavor);
                // 該当だけチェックを付け直す
                flavor_chk.checked = true;
            }
        }
        to_check()
    }

    // サイズ・フレーバー・オプションのいずれかを選択すると発動
    const to_check = () => {
        // カートの空表記を削除
        if ( document.getElementsByClassName('order__none').length ) {
            document.querySelector('.order__none').remove();
            order_total.className = 'order__cart--total d-flex justify-content-between mx-2 mb-4';
            document.querySelector('.order__cart--border').className = 'order__cart--border mx-2';
            document.querySelector('.order__btn').className = 'order__btn';
        }

        // サイズ・オプションの取得金額にデフォルト値を設定
        let size_total = 0;
        let flavor_total = 0;
        let option_total = 0;

        // カートのサイズ項目を初期化
        size_title.textContent = '';
        size_price.textContent = '';
        // サイズ選択時の挙動
        for ( let i = 0; i < size.length; i++ ) {
            if ( size[i].checked ) {
                // エラーメッセージを非表示
                size_error.className = 'd-none';
                // バリュー値を取得してカートに表示
                let size_value = size[i].value.split(' ');
                size_title.textContent = size_value[0];
                size_price.textContent = '\xA5' + size_value[1];
                size_total = Number(size_value[1]);
                // シングルサイズを選択でフレーバー金額を2倍に変更
                if ( size[1].checked ) {
                    for ( let g = 0; g < flavorPriceArea.length; g++ ) {
                        if ( flavorPriceArea[g].textContent == '\xA530' ) {
                            flavorPriceArea[g].textContent = '\xA560';
                        }
                    }
                }
            }
        }
        if ( size[1].checked == false ) {
            for ( let h = 0; h < flavorPriceArea.length; h++ ) {
                if ( flavorPriceArea[h].textContent == '\xA560' ) {
                    flavorPriceArea[h].textContent = '\xA530';
                }
            }
        }

        // カートのフレーバー項目を初期化
        flavor_title.textContent = '';
        flavor2_title.textContent = '';
        flavor_price.textContent = '';
        flavor2_price.textContent = '';
        // フレーバー選択時の挙動
        for ( let j = 0; j < flavor.length; j++ ) {
            if ( flavor[j].checked ) {
                // エラーメッセージを非表示
                flavor_error.className = 'd-none';
                // バリュー値を取得してカートに表示
                let flavor_value = flavor[j].value.split(' ');

                // フレーバー未選択の場合
                if ( flavor_title.textContent == '' && flavor2_title.textContent == '' ) {
                    // ダブルサイズ選択の場合
                    if ( size[2].checked ) {
                        flavor_title.textContent = flavor_value[0];
                        flavor_price.textContent =  '\xA5' + flavor_value[1];
                        flavor2_title.textContent = flavor_value[0];
                        flavor2_price.textContent = '\xA5' + flavor_value[1];
                    // シングルサイズ選択の場合
                    } else if ( size[1].checked ) {
                        flavor_title.textContent = flavor_value[0];
                        flavor_price.textContent =  '\xA5' + flavor_value[1]*2;
                    } else {
                        flavor_title.textContent = flavor_value[0];
                        flavor_price.textContent = '\xA5' + flavor_value[1];
                    }
                // フレーバーが1つ選択されている場合
                } else if ( flavor_title.textContent != '' ) {
                    flavor2_title.textContent = flavor_value[0];
                    flavor2_price.textContent = '\xA5' + flavor_value[1];
                }

                // ダブルでフレーバーが1つ選択されている場合の合計値
                if ( size[2].checked && flavor_title.textContent == flavor2_title.textContent ) {
                    flavor_total = Number(flavor_value[1])*2;
                // ダブルで2つ目のフレーバーを選択する場合の合計値
                } else if ( size[2].checked ) {
                    flavor_total /= 2
                    flavor_total += Number(flavor_value[1]);
                // ミニorシングルでの合計値
                } else {
                    flavor_total += Number(flavor_value[1]);
                }
            }
        }

        // オプション選択時の挙動
        option_title.textContent = '';
        option_price.textContent = '';
        option2_title.textContent = '';
        option2_price.textContent = '';
        option3_title.textContent = '';
        option3_price.textContent = '';
        option4_title.textContent = '';
        option4_price.textContent = '';
        for ( let k = 0; k < option.length; k++ ) {
            if ( option[k].checked ) {
                let option_value = option[k].value.split(' ');
                if ( k == 0 ) {
                    option_title.textContent = option_value[0];
                    option_price.textContent = '\xA5' + option_value[1];
                } else if ( k == 1 ) {
                    option2_title.textContent = option_value[0];
                    option2_price.textContent = '\xA5' + option_value[1];
                } else if ( k == 2 ) {
                    option3_title.textContent = option_value[0];
                    option3_price.textContent = '\xA5' + option_value[1];
                } else if ( k == 3 ) {
                    option4_title.textContent = option_value[0];
                    option4_price.textContent = '\xA5' + option_value[1];
                }
                option_total += Number(option_value[1]);
            }
        }
        // 非同期通信状態かリロードされたかを判定
        if ( total.textContent == 0 && postArea.children.length == 0 ) {
            total_price.textContent = '\xA5' +  ( size_total + flavor_total + option_total );
        } else if ( total.textContent == 0 && '{{ get_total_price }}' > 0 ) {
            // データベースから最新の合計値を取得して足す
            let total_fee = Number('{{ get_total_price }}') + size_total + flavor_total + option_total;
            total_price.textContent = '\xA5' + total_fee.toLocaleString();
        } else {
            // カンマを除いて整数値へ変換後、非同期通信で合計値を足す
            let total_flag = total.textContent.replace( /,/g, '');
            let total_fee = Number(total_flag) + size_total + flavor_total + option_total;
            total_price.textContent = '\xA5' + total_fee.toLocaleString();
        }

        // カートの空表記を判定
        if ( total_price.textContent == '\xA5' + '0' && flavor_title.textContent == '' ) {
            order_total.className = 'order__cart--total d-none';
            document.querySelector('.order__cart--border').className = 'order__cart--border d-none';
            document.querySelector('.order__btn').className = 'order__btn d-none';
            order_total.insertAdjacentHTML(
                'beforebegin',
                '<p class="order__none mb-4">カートは空です。<br>ぜひお買い物をお楽しみください。</p>'
            );
        }
    }

    // CSRF対策
    const getCookie = name => {
        if (document.cookie && document.cookie !== '') {
            for (const cookie of document.cookie.split(';')) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) {
                    return decodeURIComponent(value);
                }
            }
        }
    };
    const csrftoken = getCookie('csrftoken');


    // データベースにカートを登録
    const cartRegi = () => {
        const url = '{% url "add_order" %}';
        // URLのクエリパラメータを管理
        const body = new URLSearchParams();
        body.append('size_title', size_title.textContent);
        body.append('size_price', Number(size_price.textContent.slice(1)));
        body.append('flavor_title', flavor_title.textContent);
        body.append('flavor_price', Number(flavor_price.textContent.slice(1)));
        body.append('flavor2_title', flavor2_title.textContent);
        body.append('flavor2_price', Number(flavor2_price.textContent.slice(1)))
        body.append('option_title', option_title.textContent);
        body.append('option_price', Number(option_price.textContent.slice(1)))
        body.append('option2_title', option2_title.textContent);
        body.append('option2_price', Number(option2_price.textContent.slice(1)))
        body.append('option3_title', option3_title.textContent);
        body.append('option3_price', Number(option3_price.textContent.slice(1)))
        body.append('option4_title', option4_title.textContent);
        body.append('option4_price', Number(option4_price.textContent.slice(1)))

        fetch(url, {
            method: 'POST',
            body: body,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                'X-CSRFToken': csrftoken,
            }
        }).then(response => {
            // JSON形式に変換
            return response.json();
        }).then(response => {
            // 選択を初期化
            invalid(size);
            invalid(flavor);
            invalid(option);
            // 選択したカート情報を初期化
            size_title.textContent = '';
            size_price.textContent = '';
            flavor_title.textContent = '';
            flavor_price.textContent = '';
            flavor2_title.textContent = '';
            flavor2_price.textContent = '';
            option_title.textContent = '';
            option_price.textContent = '';
            option2_title.textContent = '';
            option2_price.textContent = '';
            option3_title.textContent = '';
            option3_price.textContent = '';
            option4_title.textContent = '';
            option4_price.textContent = '';
            total_price.textContent = '\xA5' + response.get_total_price.toLocaleString();
            // カートの数値を更新
            if ( window.innerWidth < 576 ) {
                document.querySelector('.spfooter__menu--badge').textContent = response.count;
            } else {
                document.querySelector('.header__link--badge').textContent = response.count;
            }
        
            // 仮の合計金額を初期化
            total.textContent = '';
            // 追加するエレメント
            const element  = Object.assign(document.createElement('div'), { className: 'd-flex justify-content-between mx-2'});
            const element2  = Object.assign(document.createElement('strong'), { className: 'order__cart--content--size', textContent: response.size_title });
            const element3  = Object.assign(document.createElement('div'));
            const element4  = Object.assign(document.createElement('strong'), { className: 'order__select--cart--price m-0', textContent: '\xA5' + response.size_price });
            const element5  = Object.assign(document.createElement('span'), { id: response.cart_id, innerHTML: '<i class="order__select--cart--delete fas fa-times-circle fa-fw" aria-hidden="true"></i>' });
            const element6  = Object.assign(document.createElement('div'), { className: 'order__select--cart d-flex justify-content-between mx-2'});
            const element7  = Object.assign(document.createElement('span'), { textContent: response.flavor_title });
            const element8  = Object.assign(document.createElement('span'), { className: 'order__select--cart--price order__cart--content--flavor', textContent: '\xA5' + response.flavor_price });
            const element9  = Object.assign(document.createElement('div'), { className: 'order__select--cart d-flex justify-content-between mx-2'});
            const element10  = Object.assign(document.createElement('span'), { textContent: response.flavor2_title });
            if ( response.flavor2_title == '' ) {
                var element11  = Object.assign(document.createElement('span'));
            } else {
                var element11  = Object.assign(document.createElement('span'), { className: 'order__select--cart--price', textContent: '\xA5' + response.flavor2_price });
            }
            const element12  = Object.assign(document.createElement('div'), { className: 'order__select--cart d-flex justify-content-between mx-2'});
            const element13  = Object.assign(document.createElement('span'), { textContent: response.option_title });
            if ( response.option_title == '' ) {
                var element14  = Object.assign(document.createElement('span'));
            } else {
                var element14  = Object.assign(document.createElement('span'), { className: 'order__select--cart--price', textContent: '\xA5' + response.option_price });
            }
            const element15  = Object.assign(document.createElement('div'), { className: 'order__select--cart d-flex justify-content-between mx-2'});
            const element16  = Object.assign(document.createElement('span'), { textContent: response.option2_title });
            if ( response.option2_title == '' ) {
                var element17  = Object.assign(document.createElement('span'));
            } else {
                var element17  = Object.assign(document.createElement('span'), { className: 'order__select--cart--price', textContent: '\xA5' + response.option2_price });
            }
            const element18  = Object.assign(document.createElement('div'), { className: 'order__select--cart d-flex justify-content-between mx-2'});
            const element19  = Object.assign(document.createElement('span'), { textContent: response.option3_title });
            if ( response.option3_title == '' ) {
                var element20  = Object.assign(document.createElement('span'));
            } else {
                var element20  = Object.assign(document.createElement('span'), { className: 'order__select--cart--price', textContent: '\xA5' + response.option3_price });
            }
            const element21  = Object.assign(document.createElement('div'), { className: 'order__select--cart d-flex justify-content-between mx-2'});
            const element22  = Object.assign(document.createElement('span'), { textContent: response.option4_title });
            if ( response.option4_title == '' ) {
                var element23  = Object.assign(document.createElement('span'));
            } else {
                var element23  = Object.assign(document.createElement('span'), { className: 'order__select--cart--price', textContent: '\xA5' + response.option4_price });
            }
            const element24  = Object.assign(document.createElement('div'), { id: 'order' + response.cart_id, className: 'mb-3' });
            // 階層に合わせて要素をまとめる
            element.appendChild(element2);
            element3.appendChild(element4);
            element3.appendChild(element5);
            element.appendChild(element3);
            element6.appendChild(element7);
            element6.appendChild(element8);
            element9.appendChild(element10);
            element9.appendChild(element11);
            element12.appendChild(element13);
            element12.appendChild(element14);
            element15.appendChild(element16);
            element15.appendChild(element17);
            element18.appendChild(element19);
            element18.appendChild(element20);
            element21.appendChild(element22);
            element21.appendChild(element23);
            element24.appendChild(element);
            element24.appendChild(element6);
            element24.appendChild(element9);
            element24.appendChild(element12);
            element24.appendChild(element15);
            element24.appendChild(element18);
            element24.appendChild(element21);
            // 最後に追加
            postArea.insertBefore(element24, postArea.lastChild.nextSibling);
            
            // 仮の合計値も変更
            total.textContent = response.get_total_price;

            // 削除ボタンにonclickを付与
            let id = document.getElementById(response.cart_id);
            id.setAttribute('onclick', 'delOrder(this);');
        }).catch(error => {
            console.log(error);
        });
    }


    // 次ページに遷移する前にエラーチェック
    const next = (next) => {
        next.addEventListener('click', e => {
            // サイズが選択されてない場合のエラーを出力
            if ( size_title.textContent == '' && postArea.children.length == 0 ) {
                e.preventDefault(); // ページ遷移をキャンセル
                size_error.className = 'error-msg d-inline-block text-left';
                size_error.textContent = '※サイズを選択してください。';
            // フレーバーが選択されてない場合のエラーを出力
            } else if ( flavor_title.textContent == '' && size_title.textContent != '' ) {
                e.preventDefault(); // ページ遷移をキャンセル
                flavor_error.className = 'error-msg d-inline-block text-left';
                flavor_error.innerHTML = '※フレーバーを選択してください。<br>※ダブルサイズの場合は2つ選択できます。';
            } else if ( size_title.textContent != '' && flavor_title.textContent != '' ) {
                cartRegi();
            }
        });
    }
    const nextOrder = document.getElementById('order_next');
    next(nextOrder);

    // 追加注文をクリックで発動
    const addOrder = document.getElementById('order_plus')
    addOrder.addEventListener('click', e => {
        e.preventDefault(); // ページ遷移をキャンセル

        // サイズが選択されてない場合のエラーを出力
        if ( size_title.textContent == '' ) {
            size_error.className = 'error-msg d-inline-block text-left';
            size_error.textContent = '※サイズを選択してください。';
        // フレーバーが選択されてない場合のエラーを出力
        } else if ( flavor_title.textContent == '' ) {
            flavor_error.className = 'error-msg d-inline-block text-left';
            flavor_error.innerHTML = '※フレーバーを選択してください。<br>※ダブルサイズの場合は2つ選択できます。';
        // サイズもフレーバーも選択されていれば発動
        } else {
            cartRegi();

            // 追加注文完了アラート
            const element  = Object.assign(document.createElement('div'), { className: 'order__alert alert alert-dismissible fade show d-flex justify-content-center align-items-center m-0 p-3'});
            const element2  = Object.assign(document.createElement('div'));
            const element3  = Object.assign(document.createElement('img'), { className: 'done-check d-block mx-auto mb-2', src: "{% static 'img/check.svg' %}" });
            const element4  = Object.assign(document.createElement('strong'), { innerHTML: 'カートに商品が<br>追加されました' });
            const element5  = Object.assign(document.createElement('button'), { className: 'order__alert--btn close', type: 'button'});
            const element6  = Object.assign(document.createElement('span'), { className: 'order__alert--close', innerHTML: '&times;'});
            // 階層に合わせて要素をまとめる
            element2.appendChild(element3);
            element2.appendChild(element4);
            element5.appendChild(element6);
            element.appendChild(element2);
            element.appendChild(element5);
            // 最後に追加
            document.body.insertBefore(element, document.body.firstChild);

            let order_alert = document.querySelector('.order__alert');
            order_alert.setAttribute('role', 'alert');
            let alert_btn = document.querySelector('.order__alert--btn');
            alert_btn.setAttribute('data-dismiss', 'alert');
            alert_btn.setAttribute('aria-label', 'Close');
            let alert_close = document.querySelector('.order__alert--close');
            alert_close.setAttribute('aria-hidden', 'true');

            // 3秒後にアラート削除
            let delete_alert = () => {
                order_alert.remove()
            }
            setTimeout(delete_alert, 2000);
        }
    });


    // カート注文の削除をクリックで発動
    const delOrder = (ele) => {
        // すべてのチェックを一旦外す
        invalid(size);
        invalid(flavor);
        invalid(option);
        size_title.textContent = '';
        size_price.textContent = '';
        flavor_title.textContent = '';
        flavor2_title.textContent = '';
        flavor_price.textContent = '';
        flavor2_price.textContent = '';
        option_title.textContent = '';
        option_price.textContent = '';
        option2_title.textContent = '';
        option2_price.textContent = '';
        option3_title.textContent = '';
        option3_price.textContent = '';
        option4_title.textContent = '';
        option4_price.textContent = '';
        let id_value = ele.id;
        const url = '{% url "delete_order" %}';
        // URLのクエリパラメータを管理
        const body = new URLSearchParams();
        body.append('id_value', id_value);

        fetch(url, {
            method: 'POST',
            body: body,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                'X-CSRFToken': csrftoken,
            }
        }).then(response => {
            // JSON形式に変換
            return response.json();
        }).then(response => {
            // 合計値を削除後の金額に変更
            total_price.textContent = '\xA5' + response.get_total_price.toLocaleString();

            // 仮の合計値も削除後の金額に変更
            total.textContent = response.get_total_price;

            // HTMLからクリックされた注文アイテムを削除
            let cart = document.getElementById('order' + id_value);
            cart.remove();

            // カートの数値を更新
            if ( window.innerWidth < 576 ) {
                document.querySelector('.spfooter__menu--badge').textContent = response.count;
            } else {
                document.querySelector('.header__link--badge').textContent = response.count;
            }

            // カートの空表記を判定
            if ( total_price.textContent == '\xA5' +'0' && flavor_title.textContent == '' ) {
                order_total.className = 'order__cart--total d-none';
                document.querySelector('.order__cart--border').className = 'order__cart--border d-none';
                document.querySelector('.order__btn').className = 'order__btn d-none';
                order_total.insertAdjacentHTML(
                    'beforebegin',
                    '<p class="order__none mb-4">カートは空です。<br>ぜひお買い物をお楽しみください。</p>'
                );
            }
        }).catch(error => {
            console.log(error);
        });
    }

    // 再注文で登録が無い場合のアラート
    if ( '{{ msg }}' != '' ) {
        const element  = Object.assign(document.createElement('div'), { className: 'order__reorder sticky-top rounded-0 alert alert-danger alert-dismissible fade show m-0' });
        const element2  = Object.assign(document.createElement('strong'), { innerText: '只今、' + '{{ msg }}' + 'はご好評につき、在庫切れとなっております。\n' + '{{ msg }}' + 'を含むご注文のみキャンセルされました。' });
        const element3  = Object.assign(document.createElement('button'), { className: 'order__reorder--btn close', type: 'button' });
        const element4  = Object.assign(document.createElement('span'), { className: 'order__reorder--close', innerHTML: '&times;' });
        // 階層に合わせて要素をまとめる
        element3.appendChild(element4);
        element.appendChild(element2);
        element.appendChild(element3);
        // 最後に追加
        document.body.insertBefore(element, document.body.firstChild);

        let order_alert = document.querySelector('.order__reorder');
        order_alert.setAttribute('role', 'alert');
        let alert_btn = document.querySelector('.order__reorder--btn');
        alert_btn.setAttribute('data-dismiss', 'alert');
        alert_btn.setAttribute('aria-label', 'Close');
        let alert_close = document.querySelector('.order__reorder--close');
        alert_close.setAttribute('aria-hidden', 'true');
    }

    // カートへスクロール
    if ( window.innerWidth < 576 ) {
        const cartJump = document.querySelectorAll('.cart-jump');
        for ( let i = 0; i < cartJump.length; i++ ) {
            cartJump[i].addEventListener('click', e => {
                e.preventDefault();
                scrollFunc('.order__cart');
            })
        }
    }

    // サイズへスクロール
    document.querySelector('.size-jump').addEventListener('click', e => {
        e.preventDefault();
        scrollFunc('.order__size');
    });

    // フレーバーへスクロール
    document.querySelector('.flavor-jump').addEventListener('click', e => {
        e.preventDefault();
        scrollFunc('.order__flavor');
    });

    // オプションへスクロール
    document.querySelector('.option-jump').addEventListener('click', e => {
        e.preventDefault();
        scrollFunc('.order__option');
    });
</script>
{% endblock %}